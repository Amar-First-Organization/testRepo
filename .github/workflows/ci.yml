name: CI

on:
  push:
    branches:
      - main
      - release-*
  pull_request:
    branches:
      - main
      - release-*

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version:
          - "19"
          - "18"
          - "16"
          - "14"
        bundle:
          - "true"
        include:
          - node-version: "*"
            bundle: "false"

    name: Test Node ${{ matrix.node-version }} with --bundle=${{ matrix.bundle }}

    steps:
    - uses: actions/checkout@v3
    - name: Use node version ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        check-latest: true
    - run:  npm ci

    - name: Tests
      # run tests, but lint separately
      run:  npm run test -- --no-lint --bundle=${{ matrix.bundle }}

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: "*"
        check-latest: true
    - run:  npm ci

    - name: Linter
      run:  npm run lint

  browser-integration:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: "*"
        check-latest: true
    - run:  npm ci

    - name: Adding playwright
      run: npm install --no-save --no-package-lock playwright

    - name: Validate the browser can import TypeScript
      run: npx hereby test-browser-integration

  typecheck:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: "*"
        check-latest: true
    - run:  npm ci

    - name: Build src
      run: npx hereby build-src

  smoke:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./pr

    steps:
    - uses: actions/checkout@v3
      with:
        path: pr

    - uses: actions/checkout@v3
      with:
        path: base
        ref: ${{ github.base_ref }}
      if: github.event_name == 'pull_request'

    - uses: actions/setup-node@v3
      with:
        node-version: "*"
        check-latest: true
    
    # Pre-build the base branch so we can check lib folder size changes.
    # Note that github.sha points to a merge commit, meaning we're testing
    # the base branch versus the base branch with the PR applied.
    - name: Build base LKG
      if: github.event_name == 'pull_request'
      run: |
        npm ci
        npx hereby lkg
        rm -rf $GITHUB_WORKSPACE/pr/lib
        mv ./lib $GITHUB_WORKSPACE/pr/
      working-directory: ./base

    - run:  npm ci

    - run: npx hereby lkg
    - run: |
        npm pack
        mv typescript*.tgz typescript.tgz
        echo "package=$PWD/typescript.tgz" >> "$GITHUB_OUTPUT"
      id: pack

    - name: Smoke test
      run: |
        cd "$(mktemp -d)"
        npm init --yes
        npm install ${{ steps.pack.outputs.package }}

        echo "Testing tsc..."
        npx tsc --version

        echo "Testing tsserver..."
        echo '{"seq": 1, "command": "status"}' | npx tsserver

        node $GITHUB_WORKSPACE/pr/scripts/checkModuleFormat.mjs typescript
        node $GITHUB_WORKSPACE/pr/scripts/checkModuleFormat.mjs typescript/lib/tsserverlibrary

  misc:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: "*"
        check-latest: true
    - run:  npm ci

    - name: Build scripts
      run: npx hereby scripts

    - name: ESLint tests
      run: npx hereby run-eslint-rules-tests

  self-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: "*"
        check-latest: true
    - run:  npm ci

    - name: Build tsc
      run: npx hereby tsc

    - name: Clean
      run: npx hereby clean-src

    - name: Self build
      run: npx hereby build-src --built
