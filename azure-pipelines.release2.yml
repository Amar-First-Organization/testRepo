trigger:
  branches:
    include:
      - release-*

pool:
  vmImage: ubuntu-latest

stages:
  - stage: buildStage
    displayName: Build Stage
    jobs:
      - job: build
        displayName: Build
        steps:
          - checkout: self
            clean: true
            fetchDepth: 1
            fetchTags: false

          - task: NodeTool@0
            inputs:
              versionSpec: 20.x
            displayName: 'Install Node'

          - script: |
              npm install -g `node -e 'console.log(JSON.parse(fs.readFileSync("package.json", "utf8")).packageManager)'`
              npm --version
            displayName: 'Install packageManager from package.json'

          - script: npm ci
            displayName: 'npm ci'

          - script: 'npm test'
            displayName: 'npm test'

          - script: |
              npx hereby LKG
              npx hereby clean
              npm pack
            displayName: 'LKG, clean, pack'

          - task: CopyFiles@2
            displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
            inputs:
              SourceFolder: ./
              Contents: 'typescript-*.tgz'
              TargetFolder: '$(Build.ArtifactStagingDirectory)'
